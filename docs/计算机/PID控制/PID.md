# PID控制算法
![PID控制结构图](img/PID控制结构图.png)
![PID控制结构图2](img/PID控制结构图2.png)
- `Sv`: 用户设定值  
- `采用数据序列`: X1,X2,...,Xk-2,Xk-1,Xk  
- `Xk`: 当前值,即Pv  
- `Ek`: 当前偏差,**Ek = Sv - Xk**  
- `OUT`: 输出控制信号  
## PID算法基础知识
### 比例控制
#### 基础知识
根据当前偏差值比例大小输出控制信号  
**out = Kp * e(t)**  
>> 即工作与停止时间的比例，类似占空比  

**缺点**: 有误差才控制，没误差时，就不会控制  
> 解决办法: 给out值添加一个常数out0(值较小) 

#### 控制公式
<font color=red>Pout = Kp * e(t)</font> + <font color=purple>OUT0</font>   
> Kp: 比例值  

### 积分控制
#### 基本知识
`历史偏差序列`: E1, E2, E3, ...Ek-2, Ek-1, Ek  

`积分值Sk`: Sk = E1 + E2 + ... + Ek-2 + Ek-1 + Ek  
> Sk > 0: 过去时间，大多数时间未达标  
> Sk < 0: 过去时间，大多数时间已超标  

`缺点`: 总是利用历史的数据来影响当前的状态，<font color=purple>不要单独的利用积分控制</font>  

`实际作用`: 在比例项失去作用时，利用积分项进行平衡  

#### 控制公式
<font color=red>Iout = Kp * Sk</font> + <font color=purple>OUT0</font>  
> Kp: 放大系数  
> Sk = 0时，将会进入失控状态,故需加入一个OUT0常数  

#### 应用注意项
在第一次到达目标之前，会出现<font color=purple>过冲现象</font>:  
> 原因: 因为历史上数据都是未达标的，从而认为未来也不达标，从而导致了超调  

> <font color=purple>解决方法(即积分分离的方法)</font>: 在当前值与误差值的相差达到70%~80%时，再将积分项加入控制  


### 微分控制
#### 基础知识
`偏差值变换量Dk`: Dk = Ek - Ek-1  
> 用最近的变化趋势预测将来的变化趋势  

> Dk > 0: 偏差有增大的趋势  
> Dk < 0: 偏差有减小的趋势  

<font size=4 color=red>不能用来独立控制</font>,只考查偏差是否有变换趋势，而不是管误差  
#### 控制公式
<font color=red>Dout = Kp * Dk</font> + <font color=purple>OUT0</font>  
> Kp: Kp越大，控制灵敏度越高  
> OUT0: 维持一种静态误差，避免失控  


## 基于单片机的PID算法
PID算法的数据模型  
```math
PIDout = P_out + I_out + D_out  
       = K_p*(E_k + S_k + D_k) + OUT0  
```
### 数据的处理
#### Sk的处理
```math
S_k = \frac{T}{T_i} * (\sum_{k = 1}^n E_k)
```
T:采用周期(或计算周期):根据实际情况来调整   
> `含义`: PID计算时间的长短  
>> 比如被控制的物体状态变换非常快时，T的值就要取小一点  

Ti: 积分常数(积分时间):  
> `含义`: 考察时间的长短  

> `积分分离方法`: 由于[过冲现象](#积分控制),常在**第一次到预设值前**，令**Ti的值极大**,即忽略掉积分项的作用  
>> 在当前值与误差值的相差达到70%~80%时，再将积分项加入控制  

#### Dk的处理
```math
D_k = T_d * (\frac{E_k - E_{k-1}}{T})
```
Td: 微分常数  

T: 采样周期(或计算周期):  
> `含义`: PID计算时间的长短  

> 当计算周期过长时，会导致变化率不明显，从而使得微分项失去作用  

###位置式PID
单片机中的计算公式表达式:  
```math
OUT = (Kp * E_k) + (K_p * \frac{T}{T_k} * \sum_{k = 1}^{n}E_K) + (K_p * \frac{T_d}{T} * (E_k-E_{k-1})) + OUT0
```
<font color=red>缺点</font>: 积分项计算较繁琐  

### 增量型PID-计算控制量的增加/减小值  
单片机中增量型和位置型差别不大  
用于控制系统本身具有记忆功能时，只需要告诉控制系统在原来的情况下增加/减少多少  
**增量型PID计算公式**:
```math
\begin{align}
\triangle{OUT} &= OUT_k - OUT_{k-1}\\
               &= K_p*(E_k - E_{k-1}) + K_p * \frac{T}{T_i}*E_k + K_p*\frac{T_d}{T}*(E_k-2E_{k-1}+E_{k-2})    \\
\end{align}
```

<font color=purple>优点</font>: 
> 能解决积分项计算复杂的问题  
> 只需要记录最近三次的偏差值就行了  

---
单片机中增量型和位置型差别不大  

## 注意点
PID不能一直的在运算，要等上一个运算的结果的控制信号落实  


















































